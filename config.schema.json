{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/deep-rent/vouch/main/config.schema.json",
  "title": "Vouch Configuration",
  "type": "object",
  "properties": {
    "local": {
      "$ref": "#/definitions/Local"
    },
    "proxy": {
      "$ref": "#/definitions/Proxy"
    },
    "guard": {
      "$ref": "#/definitions/Guard"
    }
  },
  "required": [
    "guard"
  ],
  "additionalProperties": false,
  "definitions": {
    "Local": {
      "type": "object",
      "description": "Configures the local HTTP server.",
      "properties": {
        "host": {
          "type": "string",
          "description": "Hostname or IP to bind to.",
          "default": ""
        },
        "port": {
          "type": "integer",
          "description": "TCP port to listen on. 0 will be mapped to 8080.",
          "default": 8080,
          "minimum": 0,
          "maximum": 65535
        }
      },
      "additionalProperties": false
    },
    "Proxy": {
      "type": "object",
      "description": "Configures the upstream CouchDB target and proxy headers.",
      "properties": {
        "scheme": {
          "type": "string",
          "enum": [
            "http",
            "https"
          ],
          "default": "http",
          "description": "Upstream URL scheme."
        },
        "host": {
          "type": "string",
          "default": "localhost",
          "description": "Upstream hostname or IP address."
        },
        "port": {
          "type": "integer",
          "default": 5984,
          "minimum": 0,
          "maximum": 65535,
          "description": "Upstream TCP port. 0 will be mapped to 5984."
        },
        "headers": {
          "$ref": "#/definitions/Headers"
        }
      },
      "additionalProperties": false
    },
    "Headers": {
      "type": "object",
      "description": "Customizes the proxy headers sent to CouchDB.",
      "properties": {
        "user": {
          "$ref": "#/definitions/UserHeader"
        },
        "roles": {
          "$ref": "#/definitions/RolesHeader"
        },
        "token": {
          "$ref": "#/definitions/TokenHeader"
        }
      },
      "additionalProperties": false
    },
    "UserHeader": {
      "type": "object",
      "description": "Configures the proxy user header.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Header name carrying the CouchDB user.",
          "default": "X-Auth-CouchDB-UserName"
        },
        "anonymous": {
          "type": "boolean",
          "description": "Allow forwarding anonymous requests (matching allow rule does not set user).",
          "default": false
        }
      },
      "additionalProperties": false
    },
    "RolesHeader": {
      "type": "object",
      "description": "Configures the proxy roles header.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Header name carrying comma-separated roles.",
          "default": "X-Auth-CouchDB-Roles"
        },
        "default": {
          "type": "array",
          "description": "Default roles when the matching allow rule does not set roles.",
          "items": {
            "type": "string"
          },
          "default": []
        }
      },
      "additionalProperties": false
    },
    "TokenHeader": {
      "type": "object",
      "description": "Configures the proxy token header used to secure the communication between Vouch and CouchDB.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Header name carrying the signed token.",
          "default": "X-Auth-CouchDB-Token"
        },
        "secret": {
          "type": "string",
          "description": "Shared secret used to sign the token header. If omitted or empty, the header will not be sent.",
          "default": "",
          "minLength": 32
        },
        "algorithm": {
          "type": "string",
          "description": "Hash algorithm for token signing.",
          "enum": [
            "",
            "sha",
            "sha224",
            "sha256",
            "sha384",
            "sha512"
          ],
          "default": ""
        }
      },
      "additionalProperties": false
    },
    "Guard": {
      "type": "object",
      "description": "Configures authentication and authorization.",
      "properties": {
        "token": {
          "$ref": "#/definitions/Token"
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Rule"
          },
          "minItems": 1
        }
      },
      "required": [
        "token",
        "rules"
      ],
      "additionalProperties": false
    },
    "Token": {
      "type": "object",
      "description": "Configures how incoming JWTs are validated.",
      "properties": {
        "keys": {
          "$ref": "#/definitions/Keys"
        },
        "issuer": {
          "type": "string",
          "description": "Expected value of the 'iss' claim (optional)."
        },
        "audience": {
          "type": "string",
          "description": "Expected value of the 'aud' claim (optional)."
        },
        "leeway": {
          "type": "integer",
          "description": "Allowed clock skew in seconds. Concerns 'exp' and 'nbf' claims.",
          "default": 0,
          "minimum": 0
        }
      },
      "required": [
        "keys"
      ],
      "additionalProperties": false
    },
    "Keys": {
      "type": "object",
      "description": "Sources of JWK material used to verify token signatures.",
      "properties": {
        "static": {
          "type": "string",
          "description": "Filesystem path to a JWKS document."
        },
        "remote": {
          "$ref": "#/definitions/Remote"
        }
      },
      "anyOf": [
        {
          "required": [
            "static"
          ]
        },
        {
          "required": [
            "remote"
          ]
        }
      ],
      "additionalProperties": false
    },
    "Remote": {
      "type": "object",
      "description": "Periodic retrieval of a JWKS from a remote endpoint.",
      "properties": {
        "endpoint": {
          "type": "string",
          "description": "HTTP(S) URL from which the JWKS is retrieved.",
          "format": "uri"
        },
        "interval": {
          "type": "integer",
          "description": "Poll interval in minutes. 0 will be mapped to 30.",
          "default": 30,
          "minimum": 0
        }
      },
      "required": [
        "endpoint"
      ],
      "additionalProperties": false
    },
    "Rule": {
      "type": "object",
      "description": "Represents a single authorization rule.",
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "allow",
            "deny"
          ]
        },
        "when": {
          "type": "string",
          "description": "Condition under which the rule applies (must evaluate to boolean)."
        },
        "user": {
          "type": "string",
          "description": "Expression for CouchDB user (only in 'allow' mode)."
        },
        "roles": {
          "type": "string",
          "description": "Expression for CouchDB roles (only in 'allow' mode)."
        }
      },
      "required": [
        "mode",
        "when"
      ],
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "mode": {
                "const": "deny"
              }
            }
          },
          "then": {
            "not": {
              "anyOf": [
                {
                  "required": [
                    "user"
                  ]
                },
                {
                  "required": [
                    "roles"
                  ]
                }
              ]
            }
          }
        },
        {
          "if": {
            "required": [
              "roles"
            ]
          },
          "then": {
            "required": [
              "user"
            ],
            "properties": {
              "mode": {
                "const": "allow"
              }
            }
          }
        }
      ]
    }
  }
}